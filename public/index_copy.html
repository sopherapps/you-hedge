<!DOCTYPE html>
<html>

<head>
	<title>YouHedge</title>
	<link rel="stylesheet" type="text/css" href="styles/main.css">
</head>

<script src="webOSTVjs-1.2.4/webOSTV.js" charset="utf-8"></script>
<script src="webOSTVjs-1.2.4/webOSTV-dev.js" charset="utf-8"></script>

<body>
	<div id="app">
	</div>
	<script>
		window.apiKey = "AIzaSyBJ7FLIiIC5QPqx2Pm_uv8x4HWBg6GE3CA";
		window.youtubeBaseURL = "https://www.googleapis.com/youtube/v3";
		window.token = ""; // save the token in https://webostv.developer.lge.com/api/webos-service-api/db/
		/**
		 * Gets the details of a channel including the name and the link to the uploads
		 * */
		async function getChannelDetails(id) {
			const response = await fetch(`${window.youtubeBaseURL}/channels?part=snippet,contentDetails&id=${id}&key=${window.apiKey}`, {
				method: "GET",
				headers: { "Content-Type": "application/json", "Authorization": `Bearer ${window.token}` }
			});

			if (!response.ok) {
				console.log(response.text);
				alert("error fetching data");
				return;
			}

			const detail = await response.json();
			/*
			{
				"kind": "youtube#channelListResponse",
				"etag": "V6AHHvxigqXAq5Sov2u9OONWejo",
				"pageInfo": {
					"totalResults": 1,
					"resultsPerPage": 5
				},
				"items": [
					{
					"kind": "youtube#channel",
					"etag": "6qY_0bE5dZC9JDu7xJj9Wy3K8Jc",
					"id": "UCpyvKj4fs50RhBMrQXynbtw",
					"snippet": {
						"title": "St. Francis Chapel MAK",
						"description": "",
						"publishedAt": "2018-03-07T12:17:06Z",
						"thumbnails": {
						"default": {
							"url": "https://yt3.ggpht.com/ytc/AKedOLQPRgM5s0J6kbsTuua8dzaPtK5ayus3uqRRW6gvYQ=s88-c-k-c0x00ffffff-no-rj",
							"width": 88,
							"height": 88
						},
						"medium": {
							"url": "https://yt3.ggpht.com/ytc/AKedOLQPRgM5s0J6kbsTuua8dzaPtK5ayus3uqRRW6gvYQ=s240-c-k-c0x00ffffff-no-rj",
							"width": 240,
							"height": 240
						},
						"high": {
							"url": "https://yt3.ggpht.com/ytc/AKedOLQPRgM5s0J6kbsTuua8dzaPtK5ayus3uqRRW6gvYQ=s800-c-k-c0x00ffffff-no-rj",
							"width": 800,
							"height": 800
						}
						},
						"localized": {
						"title": "St. Francis Chapel MAK",
						"description": ""
						}
					},
					"contentDetails": {
						"relatedPlaylists": {
						"likes": "",
						"uploads": "UUpyvKj4fs50RhBMrQXynbtw"
						}
					}
					}
				]
				}
			*/

			const channelDetailsReceived = new CustomEvent("channelDetailsReceived", { detail });
			document.dispatchEvent(channelDetailsReceived);
		}

		async function getVideoList(playlistId, pageToken) {
			const response = await fetch(`${window.youtubeBaseURL}/playlistItems?part=snippet&playlistId=${uploadsId}&pageToken=${pageTokenId}&key=${window.apiKey}`, {
				method: "GET",
				headers: { "Content-Type": "application/json", "Authorization": `Bearer ${window.token}` },
			})

			if (!response.ok) {
				console.log(response.text);
				alert("error fetching data");
				return;
			}

			const detail = await resp.json();
			/*
			{
				"kind": "youtube#playlistItemListResponse",
				"etag": "Y9FblUhJPJuq_z0AMlACdqttojE",
				"nextPageToken": "EAAaBlBUOkNBVQ",
				"items": [
					{
					"kind": "youtube#playlistItem",
					"etag": "CeYJHXD3PV5j-fsUyhuWWMocOK0",
					"id": "VVVweXZLajRmczUwUmhCTXJRWHluYnR3LnhwcU5qdWFvUjBB",
					"snippet": {
						"publishedAt": "2022-07-24T11:49:06Z",
						"channelId": "UCpyvKj4fs50RhBMrQXynbtw",
						"title": "FATHER'S UNION 10th ANNIVERSARY AND ENROLLMENT|24.07.2022",
						"description": "St. Francis Chapel is a healthy and growing church, holistically transformed to Godliness. \r\nWe  are a cell based church, small enough to care and BIG enough to celebrate. \r\nWe exist to make disciples who make disciples for Jesus Christ",
						"thumbnails": {
						"default": {
							"url": "https://i.ytimg.com/vi/xpqNjuaoR0A/default.jpg",
							"width": 120,
							"height": 90
						},
						"medium": {
							"url": "https://i.ytimg.com/vi/xpqNjuaoR0A/mqdefault.jpg",
							"width": 320,
							"height": 180
						},
						"high": {
							"url": "https://i.ytimg.com/vi/xpqNjuaoR0A/hqdefault.jpg",
							"width": 480,
							"height": 360
						}
						},
						"channelTitle": "St. Francis Chapel MAK",
						"playlistId": "UUpyvKj4fs50RhBMrQXynbtw",
						"position": 0,
						"resourceId": {
						"kind": "youtube#video",
						"videoId": "xpqNjuaoR0A"
						},
						"videoOwnerChannelTitle": "St. Francis Chapel MAK",
						"videoOwnerChannelId": "UCpyvKj4fs50RhBMrQXynbtw"
					}
					},
					{
					"kind": "youtube#playlistItem",
					"etag": "04L_QaH3JeTwh4OLcRAzxQAjU6o",
					"id": "VVVweXZLajRmczUwUmhCTXJRWHluYnR3LkJkVFV6UW8xalA4",
					"snippet": {
						"publishedAt": "2022-07-24T07:30:11Z",
						"channelId": "UCpyvKj4fs50RhBMrQXynbtw",
						"title": "St. Francis Chapel Makerere Children's church Service /Going with God.  24th July 2022",
						"description": "",
						"thumbnails": {
						"default": {
							"url": "https://i.ytimg.com/vi/BdTUzQo1jP8/default.jpg",
							"width": 120,
							"height": 90
						},
						"medium": {
							"url": "https://i.ytimg.com/vi/BdTUzQo1jP8/mqdefault.jpg",
							"width": 320,
							"height": 180
						},
						"high": {
							"url": "https://i.ytimg.com/vi/BdTUzQo1jP8/hqdefault.jpg",
							"width": 480,
							"height": 360
						}
						},
						"channelTitle": "St. Francis Chapel MAK",
						"playlistId": "UUpyvKj4fs50RhBMrQXynbtw",
						"position": 2,
						"resourceId": {
						"kind": "youtube#video",
						"videoId": "BdTUzQo1jP8"
						},
						"videoOwnerChannelTitle": "St. Francis Chapel MAK",
						"videoOwnerChannelId": "UCpyvKj4fs50RhBMrQXynbtw"
					}
					}
				]
			}
			*/
			const videoListReceived = new CustomEvent("videoListReceived", { detail });
			document.dispatchEvent(videoListReceived);
		}

		/**
		 *  Creates the element that contains the channel list and returns it
		 * */
		function createChannelListElem() {
			const channels = [
				["St. Francis Mak", "UCpyvKj4fs50RhBMrQXynbtw",]
			];
			const channelList = document.createElement("ul");
			channelList.classList = "side-bar";
			channelList.innerHTML = channels.reduce(
				(prev, curr) => `${prev}<li> <button onclick="getChannelDetails('${curr[1]}')">${curr[0]}</button></li>`, "");
			return channelList;
		}

		function createVideoListElem(channelDetails) {
			// add banner of channel
			// add a list of cards showing videos
			// and prev and next buttons
		}

		/**
		 * Attempts to get the token from the DB8 and if it fails, makes user login
		 * */
		function setTokenOrLogin() {
			// TODO: implement storage of token in DB8 as well as its retrieval
			window.token = "";
		}

		/**
		 * Creates the content area
		 * */
		function createContentArea() {
			const contentArea = document.createElement("div");
			contentArea.classList = "content-area";

			document.addEventListener("channelDetailsReceived", function (e) {
				const { detail } = e;
				const { uploads: uploadsId } = detail?.items[0]?.contentDetails?.relatedPlaylists;
				// TODO: We could use the upload id to get the playlists
				// or get them all at the same time within the getChannelDetails call
				contentArea.innerHTML = JSON.stringify(detail);
			}, false);

			return contentArea;
		}

		(function () {
			const rootElement = document.getElementById("app");
			rootElement.appendChild(createChannelListElem());
			rootElement.appendChild(createContentArea());
		})()
	</script>
</body>

</html>